<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Music Visualizer</title>
</head>

<body style="margin:0; background:black; overflow:hidden;">
<input type="file" id="file" accept="audio/*"
       style="position:fixed; z-index:10;">

<button id="gsBtn"
style="
position:fixed;
top:10px;
right:10px;
z-index:20;
padding:8px 12px;
background:#111;
color:white;
border:1px solid #555;
border-radius:6px;
cursor:pointer;
">
Green Screen: OFF
</button>

<canvas id="c"></canvas>

<script>
let greenScreen = false;

const gsBtn = document.getElementById("gsBtn");
gsBtn.onclick = () => {
  greenScreen = !greenScreen;
  gsBtn.textContent = "Green Screen: " + (greenScreen ? "ON" : "OFF");
};

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const analyser = audioCtx.createAnalyser();
analyser.fftSize = 2048;

document.getElementById("file").onchange = e => {
  audioCtx.resume();

  const audio = new Audio(URL.createObjectURL(e.target.files[0]));
  audio.loop = true;

  const src = audioCtx.createMediaElementSource(audio);
  src.connect(analyser);
  analyser.connect(audioCtx.destination);

  audio.play();
  draw();
};

function draw() {
  requestAnimationFrame(draw);

  const data = new Uint8Array(analyser.frequencyBinCount);
  analyser.getByteFrequencyData(data);

  if (greenScreen) {
  ctx.fillStyle = "#00FF00"; // 크로마키용 그린
  ctx.fillRect(0, 0, canvas.width, canvas.height);
} else {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

const midY = canvas.height / 2;
const barCount = data.length;

// 전체 폭을 정확히 나눔
const barWidth = Math.floor(canvas.width / barCount);

data.forEach((v, i) => {
  const barHeight = v * 0.8;
  const x = i * barWidth;

  // 마지막 바가 캔버스 넘어가면 스킵
  if (x + barWidth > canvas.width) return;

  const gradient = ctx.createLinearGradient(
    0,
    midY - barHeight,
    0,
    midY + barHeight
  );
  gradient.addColorStop(0, "#7FDBFF");
  gradient.addColorStop(1, "#0050FF");

  ctx.fillStyle = gradient;

  // 위
  ctx.fillRect(x, midY - barHeight, barWidth, barHeight);
  // 아래
  ctx.fillRect(x, midY, barWidth, barHeight);
});
}
</script>
</body>
</html>

